# Deployment Agent Documentation

**Scope**: Production deployment of quickapi-based applications on GNU/Linux systems
**Version**: 1.0.0
**Applies to**: All quickapi applications

---

## Terminology

- **system**: ASDF system definition (the `.asd` file)
- **entry-point**: Function that starts the HTTP server (e.g., `start-api`)
- **service**: systemd unit managing the application lifecycle
- **smoke-test**: Curl-based verification that endpoints respond correctly
- **healthcheck**: Single-endpoint liveness probe

---

## File Structure

quickapi applications MUST have this deployment structure:

```
project/
├── my-api.asd           # ASDF system definition
├── src/                 # Source code
├── .env                 # Runtime configuration (gitignored)
├── .env.example         # Configuration template (committed)
├── bin/
│   ├── start            # Start server script
│   └── healthcheck      # Liveness check script
└── scripts/
    ├── smoke-tests.sh   # Integration tests
    ├── my-api.service   # systemd unit file
    └── install.sh       # Service installation script
```

---

## Configuration Rules

### RULE-001: Environment Variables via .env

**Rule**: All runtime configuration MUST be read from environment variables, loadable from `.env` file.

**Rationale**: 12-factor app compliance. Separation of config from code.

**Agent action**: Generate `.env.example` with all required variables documented.

### RULE-002: Required Environment Variables

**Rule**: These variables MUST be defined for production:

| Variable | Type | Default | Description |
|----------|------|---------|-------------|
| PORT | integer | 8000 | HTTP listen port |
| HOST | string | 0.0.0.0 | Bind address |
| DATABASE_PATH | string | app.db | SQLite database path |
| JWT_SECRET | string | required | MUST be unique per deployment |
| DEBUG | boolean | false | Enable debug mode |

**Agent action**: Validate `.env` contains non-default JWT_SECRET before deployment.

### RULE-003: .env File Format

**Rule**: .env files MUST follow this grammar:

```ebnf
env_file    ::= line*
line        ::= comment | assignment | empty
comment     ::= '#' [^\n]* '\n'
assignment  ::= key '=' value '\n'
key         ::= [A-Z_][A-Z0-9_]*
value       ::= quoted_string | unquoted_string
quoted_string ::= '"' [^"]* '"' | "'" [^']* "'"
unquoted_string ::= [^\n#]*
empty       ::= '\n'
```

---

## Script Generation

### PATTERN-001: Start Script

**Scenario**: Launch quickapi application with proper environment loading.

**Complete Example**:
```bash
#!/bin/bash
# Start script for my-api
# Generated by quickapi

set -e

# Configuration
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_DIR="$(dirname "$SCRIPT_DIR")"
SYSTEM_NAME="my-api"

# Load .env if present
if [ -f "$PROJECT_DIR/.env" ]; then
    set -a
    source "$PROJECT_DIR/.env"
    set +a
fi

# Default values
PORT="${PORT:-8000}"
HOST="${HOST:-0.0.0.0}"

cd "$PROJECT_DIR"

# Start the server
exec sbcl --non-interactive \
    --eval "(require :asdf)" \
    --eval "(push #P\"$PROJECT_DIR/\" asdf:*central-registry*)" \
    --eval "(asdf:load-system :$SYSTEM_NAME)" \
    --eval "(my-api:start-api :port $PORT :address \"$HOST\")" \
    --eval "(loop (sleep 86400))"
```

**Rules Satisfied**: RULE-001

**Variations**:
| Scenario | Modification |
|----------|--------------|
| Quicklisp available | Replace `asdf:load-system` with `ql:quickload` |
| CCL instead of SBCL | Replace `sbcl` with `ccl`, adjust eval syntax |
| Roswell | Use `ros run` instead |

### PATTERN-002: Healthcheck Script

**Scenario**: Verify application is responding to requests.

**Complete Example**:
```bash
#!/bin/bash
# Healthcheck script
# Generated by quickapi

BASE_URL="${API_URL:-http://localhost:8000}"
ENDPOINT="/health"

response=$(curl -s -o /dev/null -w '%{http_code}' "$BASE_URL$ENDPOINT" 2>/dev/null)

if [ "$response" = "200" ]; then
    echo "OK"
    exit 0
else
    echo "FAIL: HTTP $response"
    exit 1
fi
```

**Rules Satisfied**: Binary exit code for systemd/monitoring integration.

### PATTERN-003: Smoke Tests

**Scenario**: Verify all API endpoints respond correctly after deployment.

**Complete Example**:
```bash
#!/bin/bash
# Smoke tests for my-api
# Generated by quickapi

set -e

BASE_URL="${API_URL:-http://localhost:8000}"
TOKEN="${JWT_TOKEN:-}"
FAILED=0
PASSED=0

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
NC='\033[0m'

test_endpoint() {
    local method=$1
    local endpoint=$2
    local expected_status=$3
    local data=$4
    local auth=$5

    local auth_header=""
    if [ -n "$auth" ] && [ -n "$TOKEN" ]; then
        auth_header="-H \"Authorization: Bearer $TOKEN\""
    fi

    local data_arg=""
    if [ -n "$data" ]; then
        data_arg="-d '$data'"
    fi

    local status
    status=$(eval curl -s -o /dev/null -w '%{http_code}' \
        -X $method \
        -H 'Content-Type: application/json' \
        $auth_header \
        $data_arg \
        "$BASE_URL$endpoint")

    if [ "$status" = "$expected_status" ]; then
        echo -e "${GREEN}✓${NC} $method $endpoint -> $status"
        ((PASSED++))
    else
        echo -e "${RED}✗${NC} $method $endpoint -> $status (expected $expected_status)"
        ((FAILED++))
    fi
}

echo "Running smoke tests against $BASE_URL"
echo "=========================================="

# Public endpoints (no auth)
test_endpoint GET /health 200 "" ""

# Auth endpoints
test_endpoint POST /auth/register 201 '{"email":"smoke@test.com","password":"testpass123"}' ""
test_endpoint POST /auth/login 200 '{"email":"smoke@test.com","password":"testpass123"}' ""

# Protected endpoints (require JWT_TOKEN env var)
test_endpoint GET /todos 200 "" "auth"
test_endpoint POST /todos 201 '{"title":"Smoke test todo"}' "auth"

echo ""
echo "=========================================="
echo "Passed: $PASSED, Failed: $FAILED"

if [ $FAILED -gt 0 ]; then
    exit 1
fi
```

**Rules Satisfied**: Exit code 1 on any failure for CI/CD integration.

---

## systemd Integration

### PATTERN-004: systemd Unit File

**Scenario**: Production daemon management on Linux.

**Complete Example**:
```ini
[Unit]
Description=My API Service
Documentation=https://github.com/org/my-api
After=network.target
Wants=network-online.target

[Service]
Type=simple
User=www-data
Group=www-data
WorkingDirectory=/opt/my-api

# Environment
EnvironmentFile=-/opt/my-api/.env
Environment=PORT=8000

# Start command
ExecStart=/opt/my-api/bin/start

# Restart policy
Restart=always
RestartSec=5

# Security hardening
NoNewPrivileges=yes
PrivateTmp=yes
ProtectSystem=strict
ProtectHome=yes
ReadWritePaths=/opt/my-api

# Logging
StandardOutput=journal
StandardError=journal
SyslogIdentifier=my-api

[Install]
WantedBy=multi-user.target
```

**Rules Satisfied**: Security hardening, automatic restart, journald logging.

### PATTERN-005: Service Installation Script

**Scenario**: Automate systemd service setup.

**Complete Example**:
```bash
#!/bin/bash
# Install systemd service
# Run as root

set -e

SERVICE_NAME="my-api"
PROJECT_DIR="/opt/my-api"

# Copy service file
cp "$PROJECT_DIR/scripts/$SERVICE_NAME.service" /etc/systemd/system/

# Set permissions
chmod 644 /etc/systemd/system/$SERVICE_NAME.service

# Reload systemd
systemctl daemon-reload

# Enable service (start on boot)
systemctl enable $SERVICE_NAME

echo "Service installed. Commands:"
echo "  systemctl start $SERVICE_NAME"
echo "  systemctl status $SERVICE_NAME"
echo "  journalctl -u $SERVICE_NAME -f"
```

---

## Invariants

### INV-001: Scripts Executable

All scripts in `bin/` and `scripts/*.sh` MUST have execute permission.

**Check**: `[ -x bin/start ] && [ -x bin/healthcheck ] && [ -x scripts/smoke-tests.sh ]`

### INV-002: .env.example Committed

`.env.example` MUST exist and be tracked in git. `.env` MUST be gitignored.

**Check**:
```bash
git ls-files --error-unmatch .env.example && \
grep -q "^\.env$" .gitignore
```

### INV-003: JWT_SECRET Not Default

Production `.env` MUST NOT contain placeholder JWT_SECRET.

**Check**: `! grep -q "change-this" .env`

---

## Agent Workflow

### Generating Deployment Files

**Input**: quickapi project with working API.

**Steps**:

1. **Identify system name**: Read from `.asd` file
2. **Identify entry-point**: Find function matching `start-*` or `*-start`
3. **Generate files**: Use `(quickapi:generate-deployment-files)`
4. **Set permissions**: `chmod +x bin/* scripts/*.sh`
5. **Create .env from .env.example**: Copy and customize
6. **Verify**: Run smoke tests

**Lisp invocation**:
```lisp
(quickapi:generate-deployment-files
  :directory "/path/to/project/"
  :system-name "my-api"
  :api-name "My API"
  :port 8000)
```

### Deploying to Server

**Prerequisites**:
- SBCL installed
- Quicklisp installed
- Project dependencies available

**Steps**:

```bash
# 1. Copy project to server
rsync -av --exclude='.git' ./my-api/ server:/opt/my-api/

# 2. SSH to server
ssh server

# 3. Create .env from template
cp /opt/my-api/.env.example /opt/my-api/.env
# Edit .env with production values

# 4. Install service (as root)
sudo /opt/my-api/scripts/install.sh

# 5. Start service
sudo systemctl start my-api

# 6. Verify
/opt/my-api/bin/healthcheck
```

---

## Anti-Patterns

### ANTI-001: Hardcoded Configuration

**Description**: Configuration values embedded in source code.

**Symptoms**:
- Port numbers in `.lisp` files
- Database paths without environment override
- JWT secrets in version control

**Remediation**: Move to `.env` file, use `(quickapi:getenv "VAR")`.

**Agent action**: Flag for human review. Auto-fix allowed for port/host.

### ANTI-002: Missing Health Endpoint

**Description**: No `/health` endpoint for liveness checks.

**Symptoms**:
- Load balancer cannot verify application status
- Kubernetes probes fail

**Remediation**: Add minimal health endpoint:
```lisp
(api-get "/health" ()
  (ok :status "healthy" :timestamp (get-universal-time)))
```

**Agent action**: Auto-add health endpoint if missing.

### ANTI-003: Root User Execution

**Description**: Running application as root.

**Symptoms**:
- `User=root` in systemd unit
- No User specified (defaults to root)

**Remediation**: Create dedicated service user, configure in systemd unit.

**Agent action**: Flag as security issue. MUST NOT auto-fix.

---

## Heuristics

### HEUR-001: Port Selection

**Signal**: PORT < 1024
**Confidence**: Medium (70%)
**Interpretation**: Requires root or capabilities, prefer high port behind reverse proxy
**Action**: Yellow flag. Suggest using port > 1024 with nginx/caddy frontend.

### HEUR-002: Database in Project Directory

**Signal**: DATABASE_PATH is relative path
**Confidence**: High (85%)
**Interpretation**: May have permission issues in production
**Action**: Yellow flag. Suggest absolute path in `/var/lib/my-api/`.

---

## Machine Checklist

Pre-deployment verification:

```
[ ] bin/start exists and is executable
[ ] bin/healthcheck exists and is executable
[ ] scripts/smoke-tests.sh exists and is executable
[ ] .env.example exists and is committed
[ ] .env is gitignored
[ ] JWT_SECRET in .env is not placeholder
[ ] Health endpoint exists (/health returns 200)
[ ] All smoke tests pass
[ ] systemd unit file syntax valid (systemd-analyze verify)
```

---

## quickapi Functions

| Function | Purpose | Example |
|----------|---------|---------|
| `generate-deployment-files` | Create all scripts | `(generate-deployment-files :directory "." :system-name "my-api")` |
| `generate-start-script` | Create bin/start | `(generate-start-script :stream *standard-output* :system-name "my-api")` |
| `generate-healthcheck` | Create bin/healthcheck | `(generate-healthcheck :stream *standard-output*)` |
| `generate-smoke-tests` | Create smoke-tests.sh | `(generate-smoke-tests :stream *standard-output* :base-url "http://localhost:8000")` |
| `generate-systemd-unit` | Create .service file | `(generate-systemd-unit :stream *standard-output* :api-name "my-api")` |
| `print-env-template` | Create .env.example | `(print-env-template nil :stream *standard-output*)` |
| `getenv` | Read env variable | `(getenv "PORT" :default "8000")` |
| `getenv-int` | Read as integer | `(getenv-int "PORT" :default 8000)` |
| `getenv-bool` | Read as boolean | `(getenv-bool "DEBUG" :default nil)` |
| `require-env` | Read or error | `(require-env "JWT_SECRET")` |

---

*Generated for quickapi v0.1.0*
